version: "2.1"

executors:
  # `main` uses the `circleci/python:3.6.4` docker image with a checkout of the sunrise code
  primary:
    docker:
      - image: circleci/python:3.6.4
        environment:
          APP_SECRET_KEY: "ba379e85c2426e6b0c0e3dc305e563bfec392af98898dae8256591f9d2751af7a6fc24c8b9dc540644e5d6fca9b5317dad3c9d035e3ff1ec1361223101ba4f48"
  primary_with_postgres:
    docker:
      - image: circleci/python:3.6.4
        environment:
          APP_SECRET_KEY: "ba379e85c2426e6b0c0e3dc305e563bfec392af98898dae8256591f9d2751af7a6fc24c8b9dc540644e5d6fca9b5317dad3c9d035e3ff1ec1361223101ba4f48"
          DB_NAME: sunrise
          DB_USER: sunrise
          DB_PASSWORD: password
      - image: postgres:10
        environment:
          POSTGRES_DB: sunrise
          POSTGRES_USER: sunrise
          POSTGRES_PASSWORD: password

jobs:

  # `deps` is used for cache python dependencies.
  deps:
    executor: primary
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python3.6/site-packages
      - restore_cache:
          keys:
            - deps-{{ .Branch }}-{{ .Revision }}
      - run:
          command: |
            sudo pip install pipenv
            pipenv install
      - save_cache:
          key: deps-{{ .Branch }}-{{ .Revision }}
          paths:
            - "/home/circleci/.local/share/virtualenvs/"
            - "/usr/local/bin"
            - "/usr/local/lib/python3.6/site-packages"

  # `pre_commit` is used to run pre-commit.
  pre_commit:
    executor: primary
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python3.6/site-packages
      - restore_cache:
          keys:
            - deps-{{ .Branch }}-{{ .Revision }}
      - restore_cache:
          keys:
            - pre-commit-dot-cache-{{ checksum ".pre-commit-config.yaml" }}
      - run: sudo pip install pre-commit
      - run: pre-commit run --all-files
      - save_cache:
          key: pre-commit-dot-cache-{{ checksum ".pre-commit-config.yaml" }}
          paths:
            - ~/.cache/pre-commit

  # `migrations` is used for testing migrations.
  migrations:
    executor: primary_with_postgres
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python3.6/site-packages
      - restore_cache:
          keys:
            - deps-{{ .Branch }}-{{ .Revision }}
      - run: pipenv run python manage.py migrate

  # `unit_tests` is used for running unit tests.
  unit_tests:
    executor: primary_with_postgres
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python3.6/site-packages
      - restore_cache:
          keys:
            - deps-{{ .Branch }}-{{ .Revision }}
      - run: pipenv run python manage.py test

workflows:
  version: 2
  main:
    jobs:
      - deps
      - pre_commit:
          requires:
            - deps
      - migrations:
          requires:
            - pre_commit
      - unit_tests:
          requires:
            - pre_commit
